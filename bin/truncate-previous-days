#!/bin/bash

printUsage()
{
    cat <<HELPTEXT
Remove all lines from the passed FILEs that precede the passed date in
YYYY-MM-DD format. Inside the FILEs, looks for the following date formats:
- 2017-09-22
- Fri Sep 22
- 09/22/2017
Files that do not contain any dates at all are skipped. Files that only contain
other dates are removed.
HELPTEXT
printf 'Usage: %q %s\n' "$(basename "$1")" 'YYYY-MM-DD FILE [...] [-?|-h|--help]'
}

typeset -a truncateLinesArguments=()
case "$1" in
    --help|-h|-\?)	shift; printUsage "$0"; exit 0;;
    --verbose-color|--verbose|-v)	truncateLinesArguments+=("$1"); shift;;
esac

typeset -a monthsList=(none Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec)
readonly months='\(Jan\|Feb\|Mar\|Apr\|May\|Jun\|Jul\|Aug\|Sep\|Oct\|Nov\|Dec\)'
readonly weekdays='\(Mon\|Tue\|Wed\|Thu\|Fri\|Sat\|Sun\)'

readonly isoPattern='[12][0-9][0-9][0-9]-[01][0-9]-[0123][0-9]'
readonly weekDayMonthDayPattern="${weekdays} ${months} [ 0123][0-9]"
readonly americanPattern='[01][0-9]\/[0123][0-9]\/[12][0-9][0-9][0-9]'

case "$1" in
    [12][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9])
	year="${1:0:4}"
	month="${1:5:2}"
	day="${1:8:2}"

	isoDate="$1"
	americanDate="${month}\\/${day}\\/${year}"
	weekDayMonthDayDate="${weekdays} ${monthsList[${month#0}]} ${day/#0/[0 ]}"
	;;
    '')	echo >&2 "ERROR: No date (YYYY-MM-DD) passed."; exit 2;;
    *)	echo >&2 "ERROR: Wrong date format, must be YYYY-MM-DD."; exit 2;;
esac
shift

[ $# -gt 0 ] || { printUsage "$0"; exit 2; }

readonly bs='\(^\|[^0-9a-zA-Z_-]\)' # keyword boundary start
readonly be='\($\|[^0-9a-zA-Z_-]\)' # keyword boundary end
exec truncate-lines \
    "${truncateLinesArguments[@]}" \
    --consider "/${bs}\\(${isoPattern}\\|${americanPattern}\\|${weekDayMonthDayPattern}\\)${be}/" \
    --match "/${bs}${isoDate}${be}/" -n "/${bs}${isoDate}${be}/,\$p" \
    --match "/${bs}${americanDate}${be}/" -n "/${bs}${americanDate}${be}/,\$p" \
    --match "/${bs}${weekDayMonthDayDate}${be}/" -n "/${bs}${weekDayMonthDayDate}${be}/,\$p" \
    --else-delete \
    -- "$@"
