#!/bin/bash

: ${WITHCOMMANDPREFIX_EXEC_END=;}

printUsage()
{
    cat <<HELPTEXT
Execute COMMAND and prefix its output with the command's name.
HELPTEXT
    echo
    printf 'Usage: %q %s\n' "$(basename "$1")" "-c|--command \"COMMANDLINE\" [-c ...] | --exec SIMPLECOMMAND ... $WITHCOMMANDPREFIX_EXEC_END [--exec ...] | [--] SIMPLECOMMAND [...] [-?|-h|--help]"
}

getCommandName()
{
    commandName --no-interpreter --undefined '' "$@"
}

typeset -a args=()
commandName=
while [ $# -ne 0 ]
do
    case "$1" in
	--help|-h|-\?)	shift; printUsage "$0"; exit 0;;
	--command|-c)	args+=("$1"); shift; [ -n "$commandName" ] || commandName="$(getCommandName --eval -- "$1")"; args+=("$1"); shift;;
	--exec)		args+=("$1"); shift
			typeset -a cmd=()
			while [ $# -gt 0 -a "$1" != "$WITHCOMMANDPREFIX_EXEC_END" ]
			do
			    cmd+=("$1"); shift
			done
			if [ $# -eq 0 ]; then
			    echo "ERROR: --exec command must be concluded with '${WITHCOMMANDPREFIX_EXEC_END}'"; echo; printUsage "$0"
			    exit 2
			fi >&2
			args+=("${cmd[@]}" "$1"); shift
			[ -n "$commandName" ] || commandName="$(getCommandName -- "${cmd[@]}")"
			;;
	--)		args+=("$1"); shift
			[ -n "$commandName" ] || commandName="$(getCommandName -- "$@")"
			break
			;;
	*)		args+=("$1"); shift;;
    esac
done
set -- "${args[@]}" "$@"
if [ $# -eq 0 ]; then
    printUsage >&2 "$0"
    exit 2
elif [ -z "$commandName" ]; then
    commandName="$(getCommandName -- "$@")"
fi

WITHOUTPUTTOSINK_EXEC_END="$WITHCOMMANDPREFIX_EXEC_END" \
WITHOUTPUTTOSINK_COMMAND_JOINER="$WITHCOMMANDPREFIX_COMMAND_JOINER" \
    exec withOutputToSink --bare --sink-exec prefix --first-then-indent "${commandName:-undefined} " \; "$@"
