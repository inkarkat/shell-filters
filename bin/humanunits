#!/bin/bash

printUsage()
{
    cat <<HELPTEXT
Convert numbers in text into human-readable Ki / Mi / Gi / ... units.
IEC 2-exponent suffixes by default, use --to si for 10-exponent SI units (or
--to iec for one-letter IEC ones).
HELPTEXT
    echo
    printf 'Usage: %q %s\n' "$(basename "$1")" '[--to si|iec|iec-i] [--] FILE [...] [-?|-h|--help]'
    printf 'Usage: cat FILE [...] | %q %s\n' "$(basename "$1")" '[...]'
}
typeset -a toArg=(--to iec-i)
case "$1" in
    --help|-h|-\?)	shift; printUsage "$0"; exit 0;;
    --to)		toArg=("$1" "$2"); shift; shift;;
esac

convertToHumanUnits()
{
    # numfmt only converts leading numbers (and skips anything after the
    # number), so we need to split up line(s) on each (whitespace +) number. To
    # be able to reassemble the original line breaks, we convert newline into
    # ASCII 01 = SOH (unfortunately, numfmt doesn't pass through ASCI 00 = NUL),
    # and retranslate afterwards.
    tr "$'\n'" "$'\001'" | \
	sed -e 's/\(^\|[ \t]\+\)[0-9]\+/\n&/g' -e 's/\d001/\n&/g' | \
	numfmt --invalid=ignore "${toArg[@]}" | \
	tr -d "$'\n'" | \
	sed -e 's/\d001/\n/g'
}

eval "${*:+cat -- "$@" |}" convertToHumanUnits
