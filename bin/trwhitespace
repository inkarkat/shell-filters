#!/bin/bash

: ${TRWHITESPACE_PREFIX=[38;5;246m}
: ${TRWHITESPACE_SUFFIX=[0m}

printUsage()
{
    cat <<HELPTEXT
Translate all whitespace characters (and highlight them (e.g. ${TRWHITESPACE_PREFIX}Â»Â·${TRWHITESPACE_SUFFIX}) when output
is to the terminal unless --no-color is given).
Equivalent to Vim's :set listchars=tab:Â»Â·,trail:Â¬,eol:Â¶,nbsp:Ã—
HELPTEXT
    echo
    printf 'Usage: %q %s\n' "$(basename "$1")" '[--color=(always|auto|never)|--no-color] [SED-OPTIONS ...] FILE [...] [-?|-h|--help]'
    printf 'Usage: cat FILE [...] | %q %s\n' "$(basename "$1")" '...'
}

isColor=; [ -t 1 ] && isColor=t
case "$1" in
    --help|-h|-\?)	shift; printUsage "$0"; exit 0;;
    --no-color|--color=never)
			isColor=; shift;;
    --color=always)	isColor=t; shift;;
    --color)		case "$2" in
			    always) isColor=t;;
			    never)  isColor=;;
			esac
			shift; shift
			;;
esac
if [ "$isColor" ]; then
    P="$TRWHITESPACE_PREFIX"
    P="${P//\\/\\\\}"
    P="${P//&/\\&}"
    P="${P//#/\\#}"
    literalSuffixPattern="$(printf %s "$TRWHITESPACE_SUFFIX" | sed -e 's/[][\$*.^#]/\\&/g')"
    S="$TRWHITESPACE_SUFFIX"
    S="${S//\\/\\\\}"
    S="${S//&/\\&}"
    S="${S//#/\\#}"
else
    P=''
    S=''
fi

sed -e 's# ##g' "$@" \
    | expand \
    | sed \
	-e "s# \\( *\\)#${P}Â»\\1${S}#g" -e 's# #Â·#g' \
	-e :subsequentTabsLoop -e "s#Â·\\{8\\}\\(\\(Â·\\{8\\}\\)*\\)${literalSuffixPattern}#Â»Â·Â·Â·Â·Â·Â·Â·\\1${S}#" -e 't subsequentTabsLoop' \
	-e 't next' -e :next \
	-e :trailLoop -e "s#\\(*\\)\$#Â¬\\1#g" -e 't trailLoop' \
	-e "s#Â¬\\+\$#${P}&${S}#g" \
	-e "s#Â #${P}Ã—${S}#g" \
	-e "s#\$#${P}Â¶${S}#g" \
	-e 's## #g'
